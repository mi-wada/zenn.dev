---
title: "Dockerç’°å¢ƒã«Capybaraã‚’å°å…¥ã™ã‚‹"
emoji: "ğŸ§¸"
type: "tech"
topics:
  - "rails"
  - "selenium"
  - "rspec"
  - "capybara"
published: true
published_at: "2022-08-02 19:49"
---

Dockerç’°å¢ƒã§é–‹ç™ºã—ã¦ã‚‹Railsã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«å¯¾ã—ã¦ã€E2Eãƒ†ã‚¹ãƒ†ã‚£ãƒ³ã‚°ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã‚ã‚‹Capybaraã‚’å°å…¥ã™ã‚‹éš›ã«ã¨ã“ã‚ã©ã“ã‚ãƒãƒã£ãŸã®ã§æ‰‹é †ã‚’æ›¸ãæ®‹ã™ã€‚

## å…¨ä½“åƒ

webã‚³ãƒ³ãƒ†ãƒŠä¸Šã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã€‚chromeã‚³ãƒ³ãƒ†ãƒŠã§ã¯ãƒ–ãƒ©ã‚¦ã‚¶ãŒå‹•ä½œã—ã¦ã„ã‚‹ã€‚
å¾Œè¿°ã™ã‚‹Capybaraã®è¨­å®šã®ã»ã¨ã‚“ã©ã¯ã€Capybaraã¨chromeã‚³ãƒ³ãƒ†ãƒŠã‚’é©åˆ‡ã«é€šä¿¡ã•ã›ã‚‹ãŸã‚ã®ã‚‚ã®ã€‚

![](https://storage.googleapis.com/zenn-user-upload/603c4ebe5d52-20220829.png)

## æ‰‹é †

### 1. å¿…è¦ãªgemã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Gemfileã«ä»¥ä¸‹ã®ã‚ˆã†ã«è¨˜è¿°ã—ã€capybaraã¨selenium-webdriverã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã€‚

```ruby
group :test do
  ...
  gem 'capybara'
  gem 'selenium-webdriver'
end
```

### 2. docker-compose.ymlã‚’ç·¨é›†

Seleniumã§æ“ä½œå¯èƒ½ãªãƒ–ãƒ©ã‚¦ã‚¶ãŒå‹•ä½œã™ã‚‹ã‚³ãƒ³ãƒ†ãƒŠãŒå¿…è¦ãªã®ã§ã€ãã®ãŸã‚ã®è¨­å®šã‚’docker-compose.ymlã«è¿½è¨˜ã™ã‚‹ã€‚

```yml
services:
  ...
  chrome:
    image: seleniarm/standalone-chromium
    ports:
      - "4444:4444"
    # ref: https://github.com/seleniumhq-community/docker-seleniarm#--shm-size2g
    shm_size: 2gb
```

ç§ã¯M1 macãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã®ã§ã€SeleniumãŒé…å¸ƒã—ã¦ã„ã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä¸­ã§ã‚‚ã€`seleniarm/standalone-chromium`ã‚’ç”¨ã„ãŸã€‚ARMã§ãªã„æ–¹ã¯`selenium/standalone-chrome`ãªã©ã€ç’°å¢ƒã«åˆã‚ã›ã¦é¸ã‚“ã§ãã ã•ã„ã€‚

ã¡ãªã¿ã«ã€4444ãƒãƒ¼ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã§ã€`http://localhost:4444`ã§Seleniumã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’ã¿ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

![](https://storage.googleapis.com/zenn-user-upload/31dc16007b13-20220802.png)

### 3. Capybaraã®è¨­å®š

`spec/rails_helper.rb`ã«ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’è¨˜è¿°ã™ã‚‹ã€‚

```ruby
# Capybaraã«ã€remote_chromeã¨ã„ã†åå‰ã®driverã‚’ç™»éŒ²ã™ã‚‹
Capybara.register_driver :remote_chrome do |app|
  options = {
    browser: :remote,
    # remote browserãŒå‹•ä½œã—ã¦ã„ã‚‹urlã‚’æŒ‡å®š
    # ä»Šå›ã¯`chrome`ã¨ã„ã†åå‰ã§`docker-compose.yml`ã«ç™»éŒ²ã—ãŸã®ã§hoståã¯`chrome`
    url: 'http://chrome:4444/wd/hub',
    capabilities: Selenium::WebDriver::Remote::Capabilities.chrome(
      # å„è¨­å®šã¯ã“ã“ã‚’å‚ç…§: https://peter.sh/experiments/chromium-command-line-switches/
      'goog:chromeOptions': {
        args: %w[
          headless
          disable-gpu
          window-size=1400,2000
          no-sandbox
        ]
      }
    )
  }

  Capybara::Selenium::Driver.new(app, options)
end

# javascript_driverã«ä¸Šã§ç™»éŒ²ã—ãŸremote_chromeã‚’æŒ‡å®šã™ã‚‹
Capybara.javascript_driver = :remote_chrome

# Capybaraã¯testã®ãŸã‚ã«ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ã€‚rails-rspecã‚’ç”¨ã„ã¦ã„ã‚‹ãªã‚‰ã€RailsãŒèµ·å‹•ã™ã‚‹ã€‚
# ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚¤ãƒ¡ãƒ¼ã‚¸
# rails s -b {Capybara.server_host} -p {Capybara.server_port}
# `Capybara.server_host`ã«ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã™ã‚‹hostã‚’æŒ‡å®šã™ã‚‹ã€‚åˆ¥ã®ãƒ›ã‚¹ãƒˆã®ãƒ–ãƒ©ã‚¦ã‚¶ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹ãŸã‚ã€`0.0.0.0`ã‚’æŒ‡å®šã™ã‚‹ã€‚
# `Capybara.server_port`ã«ã‚µãƒ¼ãƒãƒ¼ãŒlistenã™ã‚‹portã‚’æŒ‡å®šã™ã‚‹ã€‚portã‚’æŒ‡å®šã—ãªã„ã¨ãƒ©ãƒ³ãƒ€ãƒ ãªãƒãƒ¼ãƒˆã§èµ·å‹•ã™ã‚‹ã®ã§é©å½“ãªå€¤ã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
# ref: https://github.com/teamcapybara/capybara/blob/a5b5a04d81e1138d6904e33ac176227d04aacce9/lib/capybara.rb#L98-L99
Capybara.server_host = '0.0.0.0'
Capybara.server_port = '9999'

# `Capybara.app_host`ã«`chrome`ã‚³ãƒ³ãƒ†ãƒŠã§å‹•ä½œã™ã‚‹ãƒ–ãƒ©ã‚¦ã‚¶ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã»ã—ã„urlã‚’æŒ‡å®šã™ã‚‹
# CapybaraãŒç«‹ã¡ä¸Šã’ã‚‹ã‚µãƒ¼ãƒãƒ¼ã®URLã‚’æŒ‡å®šã™ã‚Œã°è‰¯ã„ã€‚ãŸã ã—ã€`chrome`ã‚³ãƒ³ãƒ†ãƒŠãŒè§£æ±ºã§ãã‚‹ã‚ˆã†ãªURLã‚’æŒ‡å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
# `visit`ãƒ¡ã‚½ãƒƒãƒ‰ã«ç›¸å¯¾ãƒ‘ã‚¹ãŒæ¸¡ã•ã‚ŒãŸæ™‚ã€ã“ã®å€¤ãŒBase URLã«ãªã‚‹ã€‚
# ã¤ã¾ã‚Šã€`visit('/hoge')` = `visit("#{Capybara.app_host}/hoge")`
# ref: https://www.rubydoc.info/gems/capybara/Capybara%2FSession:visit
# `IPSocket.getaddress(Socket.gethostname)`ã¯è‡ªèº«ã®ipã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’è¿”ã™ã€‚
# ref: https://github.com/teamcapybara/capybara/blob/a5b5a04d81e1138d6904e33ac176227d04aacce9/lib/capybara.rb#L75
Capybara.app_host = "http://#{IPSocket.getaddress(Socket.gethostname)}:#{Capybara.server_port}"
```

## ãŠã‚ã‚Šã«

ä»¥ä¸Šã®è¨­å®šã‚’ã™ã‚Œã°Capybaraã«ã‚ˆã‚‹E2Eãƒ†ã‚¹ãƒˆãŒå‹•ãç’°å¢ƒãŒã§ãã‚‹ã€‚
