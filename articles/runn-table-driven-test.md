---
title: "runnã§Table driven test"
emoji: "ğŸˆ"
type: "tech"
topics:
  - "Go"
  - "runn"
  - "API"
published: true
---

## ã¯ã˜ã‚ã«

æœ€è¿‘ä»•äº‹ã§[runn](https://github.com/k1LoW/runn)ã‚’APIã®E2Eãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ä½¿ã£ã¦ã„ã¾ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªè¨˜è¿°ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’æ›¸ã‘ã‚‹ç‚¹ã¨ã€E2Eã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è² è·ãƒ†ã‚¹ãƒˆã«å®¹æ˜“ã«è»¢ç”¨ã§ãã‚‹ç‚¹ãŒæ°—ã«å…¥ã£ã¦ã„ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€runnã§Table driven testã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ãªãŠã€Table driven testã«ã¤ã„ã¦é¦´æŸ“ã¿ãŒãªã„æ–¹ã¯[Go Wiki: TableDrivenTests](https://go.dev/wiki/TableDrivenTests)ã‚’ã”è¦§ãã ã•ã„ã€‚

## å®Ÿè£…

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ã¾ã™ã€‚

<https://github.com/mi-wada/runn-table-driven-test>

ä»Šå›ã¯ä»¥ä¸‹ã®2ã¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

* `GET https://httpbin.org?q=hello` ã‚’å‘¼ã³å‡ºã™ã¨ã€`200 OK` ã‹ã¤ `{"args":{"q":"hello"}}`ã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’è¿”ã™ã€‚
* `GET https://httpbin.org?q=world` ã‚’å‘¼ã³å‡ºã™ã¨ã€`200 OK` ã‹ã¤ `{"args":{"q":"world"}}`ã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’è¿”ã™ã€‚

å…¨ä½“ã¨ã—ã¦ã“ã‚Œã‚‰ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”¨ã„ã¾ã™ã€‚

* `test.yaml`
  * å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã€‚ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«ç•°ãªã‚‹å¼•æ•°ã‚„æœŸå¾…ã™ã‚‹å€¤ã‚’å®šç¾©ã™ã‚‹ã€‚
* `parts/get.yaml`
  * ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å®Ÿè¡Œã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ãªã©ã®å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã§å…±é€šã™ã‚‹å‡¦ç†ã‚’å®šç¾©ã™ã‚‹ã€‚
* `.env`
  * ç’°å¢ƒå¤‰æ•°ã‚’å®šç¾©ã™ã‚‹ã€‚

ã§ã¯ã€ãã‚Œãã‚Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

### test.yaml

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã¨ãªã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«ç•°ãªã‚‹å¼•æ•°ã‚„æœŸå¾…ã™ã‚‹å€¤ã‚’æ›¸ãã¾ã™ã€‚

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ç­‰ã¯`parts/get.yaml`ã§è¡Œã„ã¾ã™ã€‚ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã€runnã®[includeæ©Ÿèƒ½](https://github.com/k1LoW/runn?tab=readme-ov-file#include-runner-include-other-runbook)ã‚’ä½¿ã£ã¦`parts/get.yaml`ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚

```yaml:test.yaml
desc: GET /get
steps:
  - include:
      path: ./parts/get.yaml
      vars:
        q: "hello"
        want_status: 200
        want_body_args: |
          {
            "q": "hello"
          }
  - include:
      path: ./parts/get.yaml
      vars:
        q: "world"
        want_status: 200
        want_body_args: |
          {
            "q": "world"
          }
```

### parts/get.yaml

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€`test.yaml`ã§å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«å®šç¾©ã—ãŸvarsã«åŸºã¥ãHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¢ã‚µãƒ¼ãƒˆã—ã¾ã™ã€‚

API_BASE_URLã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šå®Ÿè¡Œå¯¾è±¡ç’°å¢ƒã‚’å®¹æ˜“ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

ãªãŠã€`test`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯[expr-lang/expr](https://github.com/expr-lang/expr)ã®è¨˜æ³•ãŒä½¿ãˆã¾ã™[^1]ã€‚

[^1]: <https://github.com/k1LoW/runn?tab=readme-ov-file#expression-evaluation-engine>

```yaml:parts/get.yaml
runners:
  req: ${API_BASE_URL}
steps:
  - req:
      /get?q={{ vars.q }}:
        get:
          body: null
    test: |
      steps[0].res.status == vars.want_status &&
      steps[0].res.body.args == fromJSON(vars.want_body_args)
```

### .env

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦API_BASE_URLã‚’å®šç¾©ã—ã¾ã™ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã¯runnã®å®Ÿè¡Œæ™‚ã«[--enf-fileã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://github.com/k1LoW/runn/blob/20d1c931ca36136bb342a85e168fe82e2c69c94e/cmd/run.go#L152)ã§`runn run --env-file .env`ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å±•é–‹ã•ã‚Œã¾ã™ã€‚

```plaintext:.env
API_BASE_URL=https://httpbin.org
```

## å®Ÿè¡Œ

ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ğŸ‰

```console
$ runn run --verbose --env-file .env test.yaml
=== GET /get (test.yaml)
    --- (0) ... ok
        === Generated by `runn new` (parts/get.yaml)
            --- (0) ... ok
    --- (1) ... ok
        === Generated by `runn new` (parts/get.yaml)
            --- (0) ... ok


1 scenario, 0 skipped, 0 failures
```

## ãŠã‚ã‚Šã«

runnä¾¿åˆ©ã§ã™ã­ã€‚
