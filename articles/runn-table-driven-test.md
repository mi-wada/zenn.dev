---
title: "runnã§Table driven test"
emoji: "ğŸˆ"
type: "tech"
topics:
  - "Go"
  - "runn"
  - "API"
published: true
---

## ã¯ã˜ã‚ã«

æœ€è¿‘ä»•äº‹ã§APIã®E2Eãƒ†ã‚¹ãƒˆãƒ„ãƒ¼ãƒ«ã¨ã—ã¦[runn](https://github.com/k1LoW/runn)ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªè¨˜è¿°ã§ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ã‹ã‘ã‚‹ç‚¹ã¨ã€E2Eã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è² è·ãƒ†ã‚¹ãƒˆã«è»¢ç”¨ã§ãã‚‹ç‚¹ãŒæ°—ã«å…¥ã£ã¦ã„ã¾ã™ã€‚

ã“ã®è¨˜äº‹ã§ã¯ã€runnã§Table driven testã‚’å®Ÿè£…ã™ã‚‹æ–¹æ³•ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚Table driven testã«ã¤ã„ã¦ã¯[Go Wiki: TableDrivenTests](https://go.dev/wiki/TableDrivenTests)ã‚’ã”è¦§ãã ã•ã„ã€‚

## å®Ÿè£…

ä»¥ä¸‹ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’è¼‰ã›ã¦ã„ã¾ã™ã€‚

https://github.com/mi-wada/runn_table_driven_test

ä»Šå›ã¯ä»¥ä¸‹ã®2ã¤ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

* `GET https://httpbin.org?q=hello` ã‚’å‘¼ã³å‡ºã™ã¨ã€`200 OK` ã‹ã¤ `{"args":{"q":"hello"}}`ã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’è¿”ã™ã€‚
* `GET https://httpbin.org?q=world` ã‚’å‘¼ã³å‡ºã™ã¨ã€`200 OK` ã‹ã¤ `{"args":{"q":"world"}}`ã‚’å«ã‚€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ã‚’è¿”ã™ã€‚

ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å…¨ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’è¨˜è¿°ã—ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«ç•°ãªã‚‹å¼•æ•°ã‚„æœŸå¾…ã™ã‚‹å€¤ã‚’æ›¸ãã¾ã™ã€‚

ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã¯`./parts/get.yaml`ã§è¡Œã„ã¾ã™ã€‚`./parts/get.yaml`ã¯runnã®[includeæ©Ÿèƒ½](https://github.com/k1LoW/runn?tab=readme-ov-file#include-runner-include-other-runbook)ã‚’ä½¿ã£ã¦èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™ã€‚

```yaml:e2e/e2e.yaml
desc: GET /get
steps:
  - include:
      path: ./parts/get.yaml
      vars:
        q: "hello"
        want_status: 200
        want_body_args: |
          {
            "q": "hello"
          }
  - include:
      path: ./parts/get.yaml
      vars:
        q: "world"
        want_status: 200
        want_body_args: |
          {
            "q": "world"
          }
```

`./parts/get.yaml`ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå†…å®¹ã§ã™ã€‚e2e.yamlã§å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹æ¯ã«å®šç¾©ã—ãŸvarsã«åŸºã¥ãHTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¡Œã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¢ã‚µãƒ¼ãƒˆã—ã¾ã™ã€‚

API_BASE_URLã¯ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®šã—ã¦ã„ã¾ã™ã€‚

ãªãŠã€`test`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã¯[expr-lang/expr](https://github.com/expr-lang/expr)ã®è¨˜æ³•ãŒä½¿ãˆã¾ã™[^1]ã€‚

[^1]: <https://github.com/k1LoW/runn?tab=readme-ov-file#expression-evaluation-engine>

```yaml:e2e/parts/get.yaml
runners:
  req: ${API_BASE_URL}
steps:
  - req:
      /get?q={{ vars.q }}:
        get:
          body: null
    test: |
      steps[0].res.status == vars.want_status &&
      steps[0].res.body.args == fromJSON(vars.want_body_args)
```

API_BASE_URLã¯ä»¥ä¸‹ã®ã‚ˆã†ã«.envãƒ•ã‚¡ã‚¤ãƒ«ã§å®šç¾©ã—ã¦ã„ã¾ã™ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã¯runnã®å®Ÿè¡Œæ™‚ã«[--enf-fileã‚ªãƒ—ã‚·ãƒ§ãƒ³](https://github.com/k1LoW/runn/blob/20d1c931ca36136bb342a85e168fe82e2c69c94e/cmd/run.go#L152)ã§`runn run --env-file .env`ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹ã“ã¨ã§ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦å±•é–‹ã•ã‚Œã¾ã™ã€‚

```plaintext:e2e/.env
API_BASE_URL=https://httpbin.org
```

ãã—ã¦ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚è¤‡æ•°ã®ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ğŸ‰

```console
$ runn run --verbose --env-file ./e2e/.env e2e/e2e.yaml
=== GET /get (e2e/e2e.yaml)
    --- (0) ... ok
        === Generated by `runn new` (e2e/parts/get.yaml)
            --- (0) ... ok
    --- (1) ... ok
        === Generated by `runn new` (e2e/parts/get.yaml)
            --- (0) ... ok


1 scenario, 0 skipped, 0 failures
```

## ãŠã‚ã‚Šã«

runnä¾¿åˆ©ã§ã™ã­ã€‚
